<!DOCTYPE html>
{% load static %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>LocalEasy - Signature du Contrat de Bail</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/contrat.css' %}">

</head>
<body>
    <!-- Header -->
    <header id="header">
        <div class="container">
            <nav class="navbar">
                <a href="#" class="logo">
                    <i class="fas fa-home"></i>
                    LocalEasy
                </a>
                <ul class="nav-links">
                    <li><a href="#home">Accueil</a></li>
                    <li><a href="#properties">Propriétés</a></li>
                    <li><a href="#about">À propos</a></li>
                    <li><a href="#services">Services</a></li>
                    <li><a href="#testimonials">Témoignages</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
                <div class="nav-actions">
                    <a href="#" class="btn btn-secondary">Mon Compte</a>
                    <button class="mobile-menu-btn">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Section principale du contrat -->
    <section class="contract-section" id="contract">
        <div class="container">
            <h2 class="section-title">Signature du Contrat de Bail</h2>
            <div class="contract-container">
                <!-- Document du contrat -->
                <div class="contract-document">
                    <div class="contract-header">
                        <h1 class="contract-title">CONTRAT DE BAIL RÉSIDENTIEL</h1>
                        <p class="contract-subtitle">Entre le Bailleur et le Locataire</p>
                    </div>
                    
                    <div class="contract-body">
                        <div class="contract-section-title">ARTICLE 1 - OBJET DU CONTRAT</div>
                        <div class="contract-clause">
                            <p>Le présent contrat a pour objet la location d'un logement situé :</p>
                            <p><strong>Adresse :</strong> {{ property.address }}, {{ property.city }} - {{ property.postal_code }}</p>
                            <p><strong>Type :</strong> {{ property.property_type }}</p>
                            <p><strong>Surface :</strong> {{ property.surface }} m²</p>
                        </div>
                        
                        <div class="contract-section-title">ARTICLE 2 - DURÉE DU BAIL</div>
                        <div class="contract-clause">
                            <p>Le présent bail est consenti pour une durée de <strong>{{ reservation.start_date }}</strong> à compter du <strong>{{ reservation.start_date }}</strong> et se terminant le <strong>{{ reservation.end_date }}</strong>.</p>
                        </div>

                        <div class="contract-section-title">ARTICLE 3 - LOYER ET CHARGES</div>
                        <div class="contract-clause">
                            <p>Le loyer mensuel est fixé à <strong>{{ property.price }} FCFA/mois</strong>, payable d'avance le premier jour de chaque mois.</p>
                        </div>

                        <div class="contract-section-title">ARTICLE 4 - CAUTION</div>
                        <div class="contract-clause">
                            <p>Une caution d'un montant de <strong>{{ property.price }} FCFA</strong> a été versée par le locataire lors de la signature du présent contrat.</p>
                        </div>

                        <div class="contract-section-title">ARTICLE 5 - OBLIGATIONS DU LOCATAIRE</div>
                        <div class="contract-clause">
                            <p>Le locataire s'engage à :</p>
                            <ul>
                                <li>Utiliser les lieux en bon père de famille à titre de résidence principale</li>
                                <li>Payer le loyer et les charges aux dates convenues</li>
                                <li>Effectuer les menues réparations d'entretien</li>
                                <li>Permettre l'accès au logement pour les visites et travaux nécessaires</li>
                            </ul>
                        </div>

                        <div class="contract-signature-area">
                            <p>Fait à {{ property.city }}, le <span id="contract-date">{{ reservation.start_date }}</span></p>

                            <div class="signature-line">
                                <div class="signature-field">
                                    <p>Pour le Bailleur</p>
                                    <div class="signature-line-placeholder"></div>
                                    <p>{{ property.first_name }}</p> <!-- Propriétaire -->
                                </div>

                                <div class="signature-field">
                                    <p>Pour le Locataire</p>
                                    <div class="signature-line-placeholder"></div>
                                    <p id="tenant-name"></p> <!-- Locataire -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panneau de signature -->
                <div class="signature-panel">
                    <h3 class="panel-title">Signature électronique</h3>
                    
                    <div class="signature-options">
                        <div class="signature-option active" data-type="draw">
                            <div class="option-icon">
                                <i class="fas fa-pen"></i>
                            </div>
                            <div>Signer à la main</div>
                        </div>
                        <div class="signature-option" data-type="type">
                            <div class="option-icon">
                                <i class="fas fa-font"></i>
                            </div>
                            <div>Signature tapée</div>
                        </div>
                    </div>
                    
                    <div class="signature-canvas-container" id="draw-signature">
                        <canvas class="signature-canvas" id="signature-canvas"></canvas>
                        <button class="clear-signature" id="clear-signature">Effacer</button>
                    </div>
                    
                    <div class="type-signature-container" id="type-signature" style="display: none;">
                        <div class="form-group">
                            <label for="typed-signature">Votre signature</label>
                            <input type="text" id="typed-signature" class="form-control" placeholder="Saisissez votre nom complet">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-success btn-full" id="confirm-signature">Signer le contrat</button>
                        <button class="btn btn-secondary btn-full" id="download-contract">Télécharger le contrat</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer id="contact">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>LocalEasy</h3>
                    <p>Votre partenaire de confiance pour trouver facilement où vous installer. Maisons, villas, appartements et chambres dans toute la France.</p>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="footer-column">
                    <h3>Liens rapides</h3>
                    <ul class="footer-links">
                        <li><a href="#home">Accueil</a></li>
                        <li><a href="#properties">Propriétés</a></li>
                        <li><a href="#services">Services</a></li>
                        <li><a href="#about">À propos</a></li>
                        <li><a href="#testimonials">Témoignages</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Types de propriétés</h3>
                    <ul class="footer-links">
                        <li><a href="#">Maisons</a></li>
                        <li><a href="#">Villas</a></li>
                        <li><a href="#">Appartements</a></li>
                        <li><a href="#">Chambres</a></li>
                        <li><a href="#">Studios</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Contact</h3>
                    <ul class="footer-contact">
                        <li>
                            <i class="fas fa-map-marker-alt"></i>
                            <span>LocalEasy</span>
                        </li>
                        <li>
                            <i class="fas fa-phone"></i>
                            <span>+237 658 03 66 48</span>
                        </li>
                        <li>
                            <i class="fas fa-envelope"></i>
                            <span>contact@LocalEasy.cm</span>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 LocalEasy. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    <!-- Script principal -->
    <script type="text/javascript">
        // ===== INITIALISATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialisation des composants
            initializeHeader();
            initializeSignatureSystem();
            initializePDFDownload();
            initializeNavigation();
            
            // Définir la date actuelle dans le contrat
            setCurrentDate();
        });

        // ===== GESTION DU HEADER =====
        function initializeHeader() {
            const header = document.getElementById('header');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navLinks = document.querySelector('.nav-links');
            
            // Effet de défilement
            window.addEventListener('scroll', () => {
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
            
            // Menu mobile
            mobileMenuBtn.addEventListener('click', () => {
                navLinks.classList.toggle('active');
                mobileMenuBtn.innerHTML = navLinks.classList.contains('active') 
                    ? '<i class="fas fa-times"></i>' 
                    : '<i class="fas fa-bars"></i>';
            });
        }

        // ===== SYSTÈME DE SIGNATURE =====
        function initializeSignatureSystem() {
            const signatureOptions = document.querySelectorAll('.signature-option');
            const drawSignatureContainer = document.getElementById('draw-signature');
            const typeSignatureContainer = document.getElementById('type-signature');
            const signatureCanvas = document.getElementById('signature-canvas');
            const clearSignatureBtn = document.getElementById('clear-signature');
            const typedSignatureInput = document.getElementById('typed-signature');
            const confirmSignatureBtn = document.getElementById('confirm-signature');
            const tenantNameElement = document.getElementById('tenant-name');
            
            let isDrawing = false;
            let canvasContext;
            let currentSignature = null;
            
            // Initialiser le canvas
            function initCanvas() {
                canvasContext = signatureCanvas.getContext('2d');
                canvasContext.lineWidth = 2;
                canvasContext.lineCap = 'round';
                canvasContext.lineJoin = 'round';
                canvasContext.strokeStyle = '#000';
                
                // Définir les dimensions du canvas
                const containerWidth = drawSignatureContainer.clientWidth;
                const containerHeight = drawSignatureContainer.clientHeight;
                signatureCanvas.width = containerWidth;
                signatureCanvas.height = containerHeight;
                
                // Effacer le canvas
                canvasContext.fillStyle = '#f9f9f9';
                canvasContext.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }
            
            // Événements du canvas
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);
            
            // Événements tactiles pour les appareils mobiles
            signatureCanvas.addEventListener('touchstart', startDrawingTouch);
            signatureCanvas.addEventListener('touchmove', drawTouch);
            signatureCanvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                draw(e);
            }
            
            function startDrawingTouch(e) {
                e.preventDefault();
                isDrawing = true;
                drawTouch(e);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                canvasContext.lineTo(e.offsetX, e.offsetY);
                canvasContext.stroke();
                canvasContext.beginPath();
                canvasContext.moveTo(e.offsetX, e.offsetY);
                
                // Mettre à jour l'aperçu de la signature
                updateSignaturePreview();
            }
            
            function drawTouch(e) {
                if (!isDrawing) return;
                
                const touch = e.touches[0];
                const rect = signatureCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                
                canvasContext.lineTo(x, y);
                canvasContext.stroke();
                canvasContext.beginPath();
                canvasContext.moveTo(x, y);
                
                // Mettre à jour l'aperçu de la signature
                updateSignaturePreview();
            }
            
            function stopDrawing() {
                isDrawing = false;
                canvasContext.beginPath();
            }
            
            // Effacer la signature
            clearSignatureBtn.addEventListener('click', () => {
                canvasContext.fillStyle = '#f9f9f9';
                canvasContext.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
                currentSignature = null;
                tenantNameElement.textContent = '';
            });
            
            // Sélection du type de signature
            signatureOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Supprimer la classe active de toutes les options
                    signatureOptions.forEach(opt => opt.classList.remove('active'));
                    // Ajouter la classe active à l'option cliquée
                    option.classList.add('active');
                    
                    const signatureType = option.getAttribute('data-type');
                    
                    if (signatureType === 'draw') {
                        drawSignatureContainer.style.display = 'block';
                        typeSignatureContainer.style.display = 'none';
                        initCanvas();
                    } else {
                        drawSignatureContainer.style.display = 'none';
                        typeSignatureContainer.style.display = 'block';
                        updateSignaturePreview();
                    }
                });
            });
            
            // Mettre à jour l'aperçu de la signature pour la signature tapée
            typedSignatureInput.addEventListener('input', updateSignaturePreview);
            
            function updateSignaturePreview() {
                const activeOption = document.querySelector('.signature-option.active');
                const signatureType = activeOption.getAttribute('data-type');
                
                if (signatureType === 'draw') {
                    // Pour la signature dessinée, utiliser le contenu du canvas
                    currentSignature = signatureCanvas.toDataURL();
                    if (currentSignature) {
                        // Dans une application réelle, vous pourriez afficher un aperçu ici
                    }
                } else {
                    // Pour la signature tapée
                    const signatureText = typedSignatureInput.value;
                    if (signatureText) {
                        currentSignature = signatureText;
                        
                        // Mettre à jour le nom du locataire dans le contrat
                        tenantNameElement.textContent = signatureText;
                    } else {
                        currentSignature = null;
                        tenantNameElement.textContent = '';
                    }
                }
            }
            
    // JavaScript pour récupérer la signature et envoyer les données via AJAX
document.getElementById('confirm-signature').addEventListener('click', function() {
    const signatureCanvas = document.getElementById('signature-canvas');
    const typedSignature = document.getElementById('typed-signature').value;

    let signature = '';

    // Si une signature est dessinée sur le canvas, on la récupère en base64
    if (signatureCanvas && signatureCanvas.toDataURL) {
        signature = signatureCanvas.toDataURL();  // Signature dessinée (format base64)
    } 
    // Si une signature est tapée, on la récupère
    else if (typedSignature) {
        signature = typedSignature;  // Signature tapée
    }

    // Vérification si une signature est fournie
    if (!signature) {
        alert('Veuillez fournir une signature.');
        return;
    }


    const contractDate = '2025-10-06';  // Date statique du contrat
    const tenantName = 'Jean Dupont';   // Nom statique du locataire

    // Envoi des données via AJAX
    $.ajax({
        url: '{% url "contract_signature" %}',  // URL Django pour la gestion de la signature
        method: 'POST',
        data: {
            'contract_date': contractDate,   // Date du contrat
            'tenant_name': tenantName,       // Nom du locataire
            'signature': 'signature_base64', // Valeur statique
            'csrfmiddlewaretoken': '{{ csrf_token }}'  // Protection CSRF
        },
        success: function(response) {
            if (response.status === 'success') {
                window.location.href = '{% url "dashboard_client" %}';  // Redirige vers le tableau de bord
            } else {
                alert('Une erreur est survenue lors de l\'enregistrement de la signature.');
            }
        },
        error: function(xhr, status, error) {
            // Affichage de l'erreur si la requête AJAX échoue
            alert('Erreur réseau ou serveur. Veuillez réessayer.');
            console.log('Status:', status);   // Afficher le statut de l'erreur dans la console
            console.log('Error:', error);     // Afficher l'erreur spécifique dans la console
        }
    });
});

            
            // Initialiser le canvas au chargement de la page
            initCanvas();
        }

           const property = {
        address: "{{ property.address }}",
        city: "{{ property.city }}",
        postal_code: "{{ property.postal_code }}",
        property_type: "{{ property.property_type }}",
        surface: "{{ property.surface }}",
        price: "{{ property.price }}",
        tenant_name: "{{tenant_name}}" // Ou tu peux ajouter un champ pour que l'utilisateur entre son nom
    };


        // ===== TÉLÉCHARGEMENT PDF =====
        function initializePDFDownload() {
            const downloadButton = document.getElementById('download-contract');
            
            downloadButton.addEventListener('click', function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Ajouter le contenu du contrat dans le PDF
                doc.setFontSize(16);
                doc.text("CONTRAT DE BAIL RÉSIDENTIEL", 20, 30);
                doc.setFontSize(12);
                doc.text("Entre le Bailleur et le Locataire", 20, 40);

                // ARTICLE 1 - OBJET DU CONTRAT
                doc.text("ARTICLE 1 - OBJET DU CONTRAT", 20, 50);
                doc.text("Le présent contrat a pour objet la location d'un logement situé :", 20, 60);
                doc.text("Adresse : {{ property.address }}, {{ property.city }} - {{ property.postal_code }}", 20, 70);
                doc.text("Type : {{ property.property_type }}", 20, 80);
                doc.text("Surface : {{ property.surface }} m²", 20, 90);

                // ARTICLE 2 - DURÉE DU BAIL
                doc.text("ARTICLE 2 - DURÉE DU BAIL", 20, 100);
                doc.text(`Le présent bail est consenti pour une durée de 3 ans à compter du 1er septembre 2023 et se terminant le 31 août 2026.`, 20, 110);

                // ARTICLE 3 - LOYER ET CHARGES
                doc.text("ARTICLE 3 - LOYER ET CHARGES", 20, 120);
                doc.text(`Le loyer mensuel est fixé à ${property.price} FCFA, payable d'avance le premier jour de chaque mois.`, 20, 130);

                // ARTICLE 4 - CAUTION
                doc.text("ARTICLE 4 - CAUTION", 20, 140);
                doc.text(`Une caution d'un montant de ${property.price} FCFA a été versée par le locataire lors de la signature du présent contrat.`, 20, 150);

                // ARTICLE 5 - OBLIGATIONS DU LOCATAIRE
                doc.text("ARTICLE 5 - OBLIGATIONS DU LOCATAIRE", 20, 160);
                doc.text("Le locataire s'engage à :", 20, 170);
                doc.text("- Utiliser les lieux en bon père de famille à titre de résidence principale", 20, 180);
                doc.text("- Payer le loyer et les charges aux dates convenues", 20, 190);

                // Signatures
                doc.text(`Fait à ${property.city}, le 1er septembre 2023`, 20, 200);
                doc.text("Pour le Bailleur :", 20, 210);
                doc.text("M. Jean DUPONT", 20, 220);

                doc.text("Pour le Locataire :", 20, 230);
                doc.text(`[Votre nom]`, 20, 240);

                // Télécharger le PDF
                doc.save("contrat_de_bail.pdf");
            });
        }

        // ===== NAVIGATION =====
        function initializeNavigation() {
            // Navigation fluide pour les liens d'ancrage
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetId = this.getAttribute('href');
                    if (targetId === '#') return;
                    
                    const targetElement = document.querySelector(targetId);
                    if (targetElement) {
                        window.scrollTo({
                            top: targetElement.offsetTop - 80,
                            behavior: 'smooth'
                        });
                        
                        // Fermer le menu mobile s'il est ouvert
                        const navLinks = document.querySelector('.nav-links');
                        if (navLinks.classList.contains('active')) {
                            navLinks.classList.remove('active');
                            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
                            mobileMenuBtn.innerHTML = '<i class="fas fa-bars"></i>';
                        }
                    }
                });
            });
        }

        // ===== FONCTIONS UTILITAIRES =====
        function setCurrentDate() {
            const now = new Date();
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('contract-date').textContent = now.toLocaleDateString('fr-FR', options);
        }
    </script>
</body>
</html>